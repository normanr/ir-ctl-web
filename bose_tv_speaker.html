<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="mobile-web-app-capable" content="yes">
<link rel="manifest" href="site.webmanifest">
<link rel="icon" href="assets/icon-192.png" type="image/png" sizes="192x192">
<title>Bose TV Speaker Remote</title>
<script defer src="common.js"></script>
<script defer src="fa/selection.min.js"></script>
<style>
html {
	height: 100%;
}
body {
	height: 100%;
	margin: 0;
	display: grid;
	place-items: center;
	line-height: 1;
	background-color: black;
	color: white;
	font-size: 52px;
}
device {
	height: calc(2.1em * 5 + 6px * (5 - 1));
	width: calc(2.1em * 2 + 6px * (2 - 1));
	display: grid;
	grid: repeat(5, 1fr) / repeat(2, 1fr);
	grid-gap: 6px;
	border: 2px solid rgb(74 74 74);
	border-radius: 1.1em;
}
#led {
	color: darkred;
}
device div {
	display: grid;
}
device div, device button {
	border: 2px solid rgb(74 74 74);
	border-radius: 16em;
}
device div > div {
	margin: -0.2em;
}
device span {
	display: grid;
	justify-content: center;
	align-items: center;
}
device span.led {
	grid-column: 1 / -1;
	justify-items: center;
}
device > :nth-child(-n+3) {
	grid-row: 1;
}
device > :nth-of-type(1) {
	grid-column: 1;
}
device > :nth-of-type(2) {
	grid-column: 2;
}
device > button {
	padding: 0px;
}
device button {
	font-size: unset;
	line-height: unset;
	font-weight: bold;
	background-color: unset;
	color: unset;
	touch-action: none;
}
device button:focus {
	outline: none;
}
device span.cols-2 {
	grid-column: span 2;
}
device div.rows-2 {
	grid-template-rows: repeat(2, 1fr);
	grid-row: span 2;
}
device div.rows-2 button {
	border: none;
}
device button .left-1 {
	transform: translateX(-0.1em);
}
device button .left-1.grow-4-x-4 {
	transform: scaleX(1.2);
	clip-path: inset(-0.14em);
}
device button[data-keycode=KEY_BASSBOOST] {
	font-size: 0.65em;
}
</style>
</head>
<body>
<device data-keymap="bose_tv_speaker-raw">
	<span class="led">
		<i id="led" class="fas fa-circle" data-fa-transform="shrink-10 up-14"></i>
	</span>

	<button data-keycode="KEY_SOUND"><i class="fas fa-power-off"></i></button>
	<button data-keycode="KEY_TV"><i class="">TV</i></button>

	<div class="rows-2">
		<button data-keycode="KEY_VOLUMEUP" data-delays="0.1,0.1,0.1,0.1"><i class="fas fa-plus"></i></button>
		<button data-keycode="KEY_VOLUMEDOWN" data-delays="0.1,0.1,0.1,0.1"><i class="fas fa-minus"></i></button>
	</div>

	<button data-keycode="KEY_BLUETOOTH"><i class="">BT</i></button>
	<button data-keycode="KEY_BASSBOOST">BASS</button>

	<button data-keycode="KEY_MUTE"><i class="fas fa-volume-mute"></i></button>
	<button data-keycode="KEY_TEXT"><i class="">TXT</i></button>

	<span class="cols-2"><img src="assets/bose-logo.svg" width=156 height=19></span>
</device>
<script type="text/javascript">
	let touchstart = (event) => {
		event.preventDefault();
		let button = event.target.closest('button');
		if (!button) return;
		console.log(event.type, button.dataset.keycode)
		let data = {
			"keymap": button.closest('device').dataset.keymap,
			"keycode": button.dataset.keycode,
		};
		if (button.dataset.hasOwnProperty('delays')) {
			data.delays = button.dataset.delays
		}
		let led = document.getElementById('led');
		led.style = "color:red";
		let query = Object.entries(data).map(([k, v]) => escape(k) + '=' + escape(v)).join('&');
		let xhr = new XMLHttpRequest();
		xhr.open("POST", "/cgi-bin/ir-ctl-send?" + query);
		xhr.addEventListener("load", () => {
			led.style = "";
			msg = xhr.status + " " + xhr.statusText + ":\n" + xhr.response;
			if (xhr.status >= 200 && xhr.status < 300) {
				if (xhr.response) {
					console.warn(msg);
					alert(msg);
				}
			} else {
				console.error(msg);
				alert(msg);
			}
		});
		xhr.addEventListener("error", () => {
			led.style = "";
			alert("Error trying to connect to server");
		});
		xhr.send();
	};
	let touchend = (event) => {
		let button = event.target.closest('button');
		if (!button) return;
		event.preventDefault();
		console.log(event.type, button.dataset.keycode)
	};
	let buttondown = (event) => {
		if (event.button == 0) touchstart(event)
	}
	let buttonup = (event) => {
		if (event.button == 0) touchend(event)
	}
	[...document.getElementsByTagName('device')].forEach(element => {
		element.addEventListener('touchstart', touchstart);
		element.addEventListener('mousedown', buttondown);
		element.addEventListener('touchend', touchend);
		element.addEventListener('mouseup', buttonup);
	});
</script>
</body>
</html>
